# Morphogenesis

# Acknowledgement

"2014, Hoetzlein, Rama Karl. Fast Fixed-Radius Nearest Neighbors: Interactive Million-Particle Fluids. GPU Technology Conference, 2014. San Jose, CA. 2010-2014. Online at http://fluids3.com"
 
Morphogenesis started as a minimal variant of Rama Hoetzlein's Fluids SPH, cut down from gFluidSurface in gvdb-voxels, 
https://github.com/ramakarl/gvdb-voxels, 
which was in turn developed from Fluids-v3.

## "Master" branch
This is the cut down version of gFluidSurface.
Dependence on gvdb-voxels library has been removed, and CMakeLists.txt has been rewritten.
New output has been written to provide ascii .ply files for viewing in MeshLab.

This code compiles and runs with cmake 3.10, vtk-9.0, and Cuda 11.2 on Ubuntu 20.04 with GTX 980m.
and on Suse Linux cluster with Cuda 9.1 and Tesla P100.

## "Non-Reciprocal" branch
This is the **morphogenesis simulator** (in progress), with 

* viscous flow
* anisotropic fibrous elasticity
* diffusion of heat/chemicals/morphogens
* epi-genetics
* particle automata behaviour

It can used for

* general purpose soft matter simulator
* real-time simulation (depending on model size and hardware)
* biolgical morphogenesis, especially complex mechanical anatomy 
* living tissue simulation (healing, pathology, disease processes)

It is in principle a **differentiable simulator** because gradients are available for all parameters. NB functions to access this have not _yet_ been written as of April 2021.

### Build instructions  
Morphogenesis depends on Cuda-10 or higher, C++11, CCmake, and vtk-9.x.
Scripts are provided to build and install vtk-9.0.1 and Morphogenesis.
These "should" work on individual workstations or GPU clusters.

The scripts call ccmake (cmake ncrurses text-gui, usually available in non-gui environments e.g. clusters).
Press "c" for configure, twice, then "g" for generate the Makefiles.
The script creates the folder "Morphogenesis/build/".
The software is installed to "~/apps/".

If Environment Modules are installed (e.g. on a GPU cluster), then the script installs the modules in "Morphogenesis/src/module" to "~/modules", otherwise it sets the needed environment variables directly.

#### vtk-9

    cd Morphogenesis/src
    bash ./install_scripts/install_vtk.sh
    
    

NB(1) The user must ensure that vtk-9.x is installed _before_ building Morphogenesis.
    
NB(2) It is strongly recommended to use the same c++11 compiler and library for both vtk-9.x and Morphogenesis, to ensure binary ABI compatability.

#### Morphogenesis 

    cd Morphogenesis/src
    bash ./install_scripts/install_morphogenesis.sh 
    
    . install_scripts/set_env.sh
    
    Note the "dot space script" syntax is required for set_env.sh .
    This runs the script in the current shell, so that it can set the required enviroment variables.

##### Custom installation
See the details of the install scripts and module files, and adapt as needed.


### SLURM for launching batches on a cluster.

To launch a job using a Slurm script : 

    sbatch <path_to_script/scriptname.slurm>
    
e.g.
    cd Morphogenesis/data
    sbatch ../src/slurm/Morphogenesis_test1.slurm

NB SLURM writes stdout and stderr to file : 

    <working_dir>/slurm-<job_no>.out .

To check the queue : 

    squeue -u <userID>


### Executables
Within Non-Reciprocal branch executables (so far) include:

#### "make_demo2"

This is the main way of launching for testing. It reads a file called SpecificationFile.txt in the "demo" directory. 

usage:

    Morphogenesis/data/test$ ../../build/install/bin/make_demo2 ../demo


SpecificationFile.txt is generated by make_demo (see below), and contains the launch parameters for both make_demo and load_sim (see below).

make_demo_2 generates a fresh model, then runs the simulation. 
Editng SpecificationFile.txt allows all relevant parameters to be controlled in one place.
This makes iteration for development and ebugging faster.


#### "make_demo"
usage:
    
    cd data
    make_demo  num_particles  spacing  x_dim  y_dim  z_dim  demoType  simSpace
    
"demoType" sets individual particle properties in "demo/particles_pos_vel_color100001.csv", especially epigenetic states, from 3D positions.

(0:free falling, 1:remodelling & actuation, 2:diffusion & epigenetics.)
    
"simSpace" sets parameters in "SimParams." , especially gravity, and wavepool actuation.

{0:regression test, 1:Tower(256,128,256), 2:Wave pool(400,200,400), 3:Small dam break(80,60,80), 4:Dual-Wave pool(200,100,30), 5: Microgravity(160,100.160), 6: Morphogenesis small demo(80,50,80) } 
{7: used by make_demo_2 to take params from SpecificationFile.txt}
    
e.g.

    ../build/install/bin/make_demo 125 1  6 6 6  0 5       // free falling
    
    ../build/install/bin/make_demo 120 1  2 2 30  1 5
    ../build/install/bin/make_demo 600 1  4 4 30  1 5      // remodelling & actuation, with fixed, bone, tendon, muscle, elastic, mesenchyme, external actuation
    
    ../build/install/bin/make_demo 2000 1  6 6 30  1 5     //  "" , with reserve particles for growth.
    
    ../build/install/bin/make_demo 400 1  10 10 3  1 5     // diffusion & epigenetics, with reserve particles for growth.
    
    
    ../build/install/bin/make_demo 10000 1  100 10 10  1 1
    ../build/install/bin/make_demo 100000 1  100 10 100  1 1
    ../build/install/bin/make_demo 100000 1  100 100 10  1 1
    ../build/install/bin/make_demo 1000000 1  100 100 100  1 1
    
#### NB Memory usage

    Factors affecting memory requrement for Morphogenesis:
    
* 0/ Available GPU memory depends on the device + other sofftware using the GPU, especially yuor desktop, GUIs, graphics and video.
To see your current GPU memory useage and total GPU memory, call "nvidia-smi" from the commandline.

NB When running a GUI onthe GPU it is advised to use models with fewer than 100k bins and particles.
    
* 1/ The number of bins in the simulation volume. i.e. volume/particle_radius^3
Dense arrays of bins are maintained for sorting particles. genes, remodelling.
These arrays are use to profuce the dense lists of particles for each kernel, for efficient computation.

* 2/ The number of particles in the simulation

* 3/ The number of genes in the simulation will increase the size of the bin arrays(1), and the data per particle(2).

* 4/ The number of active genes among the particles will increase the size of the dense lists of particles for each active gene (1).

* 5/ The number of particles subject to remodelling per time step, will incease the size of the dense lists for each remodelling kernel.

NB the simulation volume and particle radius are set in SimParams.txt by :
        m_Param[PSIMSCALE], m_Param[PGRID_DENSITY], m_Param[PSMOOTHRADIUS],  
        m_Vec[PVOLMIN], m_Vec[PVOLMAX].
        
Where: 
        m_GridRes = (PVOLMAX-PVOLMIN)*PGRID_DENSITY*PSIMSCALE / (2*PSMOOTHRADIUS)
        
        Total number of bins = m_GridRes.x * m_GridRes.y * m_GridRes.z
        
For default PGRID_DENSITY=2, PSIMSCALE=0.005, PSMOOTHRADIUS=0.015,
This gives  m_GridRes = (PVOLMAX-PVOLMIN)/3
So 
        10x10x10 vol -> 333 bins
        30x30x30 vol -> 9,000 bins
        60x60x60 vol -> 72,000 bins
        100x100x100 vol -> 333,3333 bins
        150x150x150 vol -> 1,125,000 bins
        1000x1000x1000 vol -> 333,333,333 bins. Too big for most GPUs, would need multi-GPU on cluster.
    
    
#### NB Processing speed

Factors affecting prcoessing speed include:
    
* 0/ Available GPU blocks and cores per block, after space taken by other GPU contxts for other programs.
    
* 1/ The number of bins. These have to be processesd every time step to sort the particle data and generate the dense lists.
    
* 2/ The number of particles. 
    NB there is the possiblity of "solid" and "living" particles into separate lists (using genes), to avoid running elastic and gene kernels on fluid and non-living tissue.
    
* 3/ The length of the "active gene" and "remodelling" particle lists per time step.
    NB the system of dense lists, provides faster running for models with few active genes per particle, and few particles remodelling per time step.

CPU-only test program to generate example **"SimParams.txt"** and **"particles_pos_vel_color100001.csv"** files for specifying models, and a **"particles_pos100001.ply"** for viewing a model in e.g. Meshlab.

#### "check_demo"
usage:

    cd data
    check_demo  simulation_data_folder  output_folder
    
e.g.
    ../build/install/bin/check_demo  demo  check 
    
CPU-only test program to verify the ability to read and re-output models.

#### "load_sim"
New launch program to load data from files, and run simulation on GPU.

usage:

    cd data
    ../build/install/bin/load_sim  demo  out   num_files   steps_per_file   freeze_steps      
    save_ply(y/n)  save_csv(y/n)  save_vtp(y/n)      debug(y/n)  gene_activity(y/n)  
    remodelling(y/n)
    
    usage: load_sim  simulation_data_folder  output_folder  num_files  steps_per_file  
    freeze_steps save_ply(y/n)  save_csv(y/n)  save_vtp(y/n)  debug(0-5) gene_activity(y/n)  
    remodelling(y/n) 

    debug: 0=full speed, 1=current special output,  2=host cout, 3=device printf, 
    4=SaveUintArray(), 5=save .csv after each kernel.
    
e.g.
    cd data/test
    ./load_sim ../demo/ ../out/  10 3 1 y y y
    ./load_sim ../demo/ ../out/  10 1 6 n y y
    
    ./load_sim ../demo/ ../out/  1000 10 0 n y y y y y         
    
    // NB Now '100' frames per timestep x02-x20 snapshot after each kernel.
    //x91 end of timestep. x00 begining of simulation.
    
    
    ./load_sim ../demo/ ../out/  1000 1 10 n y y y n y                
    
    // NB now 'freeze_steps' delay the start of particle movement, 
    //while heal() forms initial bonds.
    
    
    ./load_sim ../demo/ ../out/  1000 1 10 n y y y n n
    ./load_sim ../demo/ ../out/  1000 1 10 n y y n y y
    
    ./load_sim ../demo/ ../out/  200 3 1 n n y 1 y y  // Good launch option for profiling
    
    ./load_sim ../demo_10000_1_100_10_10/ ../out/  100 30 1 n n y
    ./load_sim ../demo_100000_1_100_100_10/ ../out/  100 30 1 n n y
    ./load_sim ../demo_1000000_1_100_100_100/ ../out/  100 30 1 n n y
    
    
### Profiling the code

If you have Cuda-toolkit installed, enter "nsight-sys" at the commandline to open "Nvidia Nsight Systems".
    
On Linux, first set the 'paranoid level'

    sudo sh -c 'echo 1 >/proc/sys/kernel/perf_event_paranoid'

Call the Nsight Systems GUI

    nsight-sys
    
See 
    https://developer.nvidia.com/nsight-systems , https://docs.nvidia.com/nsight-systems/index.html
    
Follow the nsight-systems InstallationGuide.
NB especially wrt setting /proc/sys/kernel/perf_event_paranoid    

    https://docs.nvidia.com/nsight-systems/InstallationGuide/index.html#linux-requirements
    
For a an introduction to how to use Nsight Systems, see "Blue Waters Webinar: Introduction to NVIDIA Nsight Systems"   https://www.youtube.com/watch?v=WA8C48FJi3c 
    
Note, setting the "debug" value (0-5) when launching "load_sim" will have a big effect on the memory transfers, flies saved and console output, and therefore the performance.

    
### Viewing with Paraview

The .vtp files output can be viewed in Paraview. 
This allows visualization of all the parameters, and is especially relevant for diffusion of morphogens, epigenetic state, and material properties.

ParaView is a widely used scientific data visualization tool.
ParaView can be downloaded from https://www.paraview.org/

#### NB GPU conflict:
It is advised to exit Paraview before launching Morphogenesis.
Sometimes other runtime errors arrise if Paraview is still running when Morphogenesis is launched.
    
Both Paraview and Morphogenesis will both try to use your GPU. 
This may result in an _"invalid device context"_ or _"There is no device supporting CUDA"_ error.
This seems to happen specifically where the computer suspends while ParaView is open.
If ParaView fails to release the GPU after being shut down, then it may be necessary to reboot.
    
This does not arise where the two programs are run on separate machines, as when Morphogenesis is run on a cluster.
    
#### Loading the data into ParaView:
    load the .vtp file 
    select the file in the pipeline browser
    
    From the top menu bar, select "Filters->Common->Treshold"
    In Properties(Thresold2), in scalars, select FPARTICLE_ID.
    Set Maximum to the number of active particles in the simulation.
    click "Apply" (green button in Properties)
    In the third row of the tool bar, click "zoom to data" icon (four arrows pointing inwards).
    NB this is necessary, when unused particles are stored in one corner of the simulation, 
    with FPARTICLE_ID = UINT_MAX.
    
    In "Coloring" select the model parameter of interest
    Adjust the coloring scale
    
    Set the background colour:
    Select Edit->Settings
    In the pop-up window,
    select Color Pallette->Background
    Choose a colour, click Apply, Okay.
    
    For Volume rendering:
    In the top menu bar, select "Filters->Point Interpolation->Point Volume Interpolator"
    Select the new "PointVolumeInterpolator" in the pipeline browser
    In the Properties pane, select a kernel type, e.g. Gaussian Kernel or Shepard Kernel
    In Coloring, select the model parameter of interest
    Adjust the coloring scale
    In "Volume Refinement", "Representation", select "Volume"
    (Alternatively select these in the top menu, second row tool bar.)
    In Volume Rendering (near the bottom of the Properties pane), in "Volume Rendering Mode", 
    select "Smart" or "GPU"
    Click Apply (at the toip of the Properties pane.
    
    
    Also in "Volume Rendering"
    In "Blend Mode" select between "Compostite/IsoSurface/Slice"

    Colour key for F_TISSUE_TYPE:        Preset colours
                                        "Cool-warm"      "Jet"          "Black-body"
    Mesenchyme/other    tissueType =0    dark blue       dark blue      black
    Tendon              tissueType =6    pink            yellow         red-orange
    Muscle              tissueType =7    orange          orange         orange
    Cartilage           tissueType =8                    red-orange     yellow
    Bone                tissueType =9                    red            pale yellow
    Elast lig           tissueType =10   dark red        dark red       white
    
    
    Note Tissue order in "Demo" from Pos.z=0 along z-axis.
    Fixed particles, 
    mesenchyme, 
    bone, 
    tendon, 
    muscle, 
    elastic 
    tissue, 
    mesenchyme, 
    actuated particles. 
    
